<!DOCTYPE html>
<html>
<head>
	<title></title>
	<script type="text/javascript" src="instascan.min.js"></script>
</head>
<body>
	<div style="background-color: white; font-size: 42px; text-align: center"></div>
	<video id="video"></video>

	<script type="text/javascript">
		//123
		Instascan.Camera.getCameras().then(cameras => {
			let div = document.createElement('div');
			let text = cameras.map(c => c.name).join("<br>");
			div.textContent = text;
			div.style.backgroundColor = 'white';
			div.style.fontSize = '42px';

			document.body.appendChild(div);
		});
		// const video = document.querySelector('#video');

		// navigator.mediaDevices.getUserMedia(constraints)
		// .then(stream => {
		// 	video.srcObject = stream;
		// 	video.play();
		// }).catch(err => {
		// 	console.log(err)
		// });

		let scanner = new Instascan.Scanner({ video: document.querySelector('#video'), mirror: false });
      	scanner.addListener('scan', content => {
      		handleQRContent(content);
        	console.log(content);
      	});

      	Instascan.Camera.getCameras().then(cameras => {
      		console.log(cameras);
      		let camera;

		    if (cameras.length > 0) {
		    	for (var i = 0; i < cameras.length; i++) {
		    		if(cameras[i].name.indexOf('back') >= 0){
		    			camera = cameras[i];
		    			break;
		    		}
		    	}
		    	if(camera == undefined){
		      		if(isIos())
		      			camera = cameras[1];
		      		else
		      			camera = cameras[0];
		      	}
				
				try {
					scanner.start(camera);
				}
				catch (e) {
					alert(e);
				}
		      	
		    } else {
		      console.error('No cameras found.');
		    }
        }).catch(function (e) {
		    console.error(e);
	    });

	    function handleQRContent(content) {
	    	console.log(content);
	    	document.querySelector('div').textContent = content;
	    	if(content == 1) {
	    		flash('success');
	    	}
	    	else if(content == 0) {
	    		flash('fail');
	    	}
	    }

	    function flash(type) {
	    	let color;

	    	if(type == 'success')
	    		color = '#07da63';
	    	else if (type == 'fail')
	    		color = '#cc0000';

	    	document.body.style.backgroundColor = color;
	    }

	    function isIos() {
		  return [
		    'iPad Simulator',
		    'iPhone Simulator',
		    'iPod Simulator',
		    'iPad',
		    'iPhone',
		    'iPod'
		  ].includes(navigator.platform)
		  // iPad on iOS 13 detection
		  || (navigator.userAgent.includes("Mac") && "ontouchend" in document)
		}
	</script>
</body>
</html>
